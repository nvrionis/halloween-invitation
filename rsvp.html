<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RSVP to Malachar's Gathering</title>
  <link rel="icon" href="images/Halloween.jpg" type="image/jpeg"/>

  <link rel="stylesheet" href="rsvp-styles.css?v=5"/>
  <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet"/>

  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>(function(){ emailjs.init("Qs6coQYswL_5gL3a5"); })();</script>
</head>
<body>

  <div id="container">
    <header>
      <h1 id="rsvp-title" class="blood-text-container">
        <span style="--delay:0s">R</span><span style="--delay:.15s">S</span><span style="--delay:.3s">V</span><span style="--delay:.45s">P</span>
        <span style="--delay:.6s">f</span><span style="--delay:.75s">o</span><span style="--delay:.9s">r</span>
        <span style="--delay:1.05s">t</span><span style="--delay:1.2s">h</span><span style="--delay:1.35s">e</span>
        <span style="--delay:1.5s">G</span><span style="--delay:1.65s">a</span><span style="--delay:1.8s">t</span><span style="--delay:1.95s">h</span><span style="--delay:2.1s">e</span><span style="--delay:2.25s">r</span><span style="--delay:2.4s">i</span><span style="--delay:2.55s">n</span><span style="--delay:2.7s">g</span>
      </h1>
    </header>

    <section><p class="blood-text">You have been summoned.</p></section>

    <form id="rsvp-form">
      <label for="character-name" class="blood-text">Your Character:</label>

      <!-- Custom dropdown (tooltip shows Class â€” Subclass near cursor) -->
      <div class="dropdown-wrap">
        <button type="button" id="character-trigger" class="blood-text dropdown-trigger">Select your character</button>
        <div id="character-list" class="dropdown-list" role="listbox" aria-labelledby="character-trigger"></div>
        <div id="class-tooltip" class="class-tooltip" aria-hidden="true"></div>
      </div>

      <!-- Hidden real select (values + form submission) -->
      <select id="character-name" name="character-name" class="hidden-select" aria-hidden="true">
        <option value="" disabled selected hidden>Select your character</option>
        <option value="vader"      data-class="Paladin"  data-subclass="Oathbreaker"       data-image="images/signatures/vader.png">Darth Vader</option>
        <option value="joker"      data-class="Rogue"    data-subclass="Arcane Trickster"   data-image="images/signatures/joker.png">The Joker</option>
        <option value="dracula"    data-class="Sorcerer" data-subclass="Shadow"             data-image="images/signatures/dracula.png">Count Dracula</option>
        <option value="franky"     data-class="Barabarian" data-subclass="Zelot"            data-image="images/signatures/Franky.png">Frankensteinâ€™s Monster</option>
        <option value="voldemort"  data-class="WIzard"   data-subclass="Necromancer"        data-image="images/signatures/voldemort.png">Lord Voldemort</option>
        <option value="hannibal"   data-class="Bard"     data-subclass="Whispers"           data-image="images/signatures/hannibal.png">Hannibal Lecter</option>
        <option value="loki"       data-class="Cleric"   data-subclass="Trickster"          data-image="images/signatures/loki.png">Loki</option>
        <option value="freddy"     data-class="WIzard"   data-subclass="Illusions"          data-image="images/signatures/freddy.png">Freddy Krueger</option>
        <option value="maleficent" data-class="Druid"    data-subclass="Swamp"              data-image="images/signatures/maleficent.png">Maleficent</option>
        <option value="scar"       data-class="Paladin"  data-subclass="Conquest"           data-image="images/signatures/scar.png">Scar</option>
        <option value="cruella"    data-class="Bard"     data-subclass="Eloquence"          data-image="images/signatures/cruella.png">Cruella de Vil</option>
        <option value="pennywise"  data-class="Sorcerer" data-subclass="Aberant Mind"       data-image="images/signatures/pennywise.png">Pennywise</option>
        <option value="sauron"     data-class="Cleric"   data-subclass="Forge"              data-image="images/signatures/sauron.png">Sauron</option>
        <option value="wicked"     data-class="WIzard"   data-subclass="Evocation"          data-image="images/signatures/wicked.png">Wicked Witch</option>
        <option value="hook"       data-class="Rogue"    data-subclass="Shawbuckler"        data-image="images/signatures/hook.png">Captain Hook</option>
        <option value="jaffar"     data-class="Sorcerer" data-subclass="Dao"                data-image="images/signatures/jaffar.png">Jafar</option>
        <option value="ursula"     data-class="Warlock"  data-subclass="Fathomless"         data-image="images/signatures/ursula.png">Ursula</option>
        <option value="hades"      data-class="Warlock"  data-subclass="Fiend"              data-image="images/signatures/hades.png">Hades</option>
        <option value="queen"      data-class="Warlock"  data-subclass="Hexblade"           data-image="images/signatures/queen.png">The Queen of Hearts</option>
        <option value="phantom"    data-class="Bard"     data-subclass="Creation"           data-image="images/signatures/phantom.png">The Phantom of the Opera </option>
        <option value="mummy"      data-class="Cleric"   data-subclass="Death"              data-image="images/signatures/mummy.png">The Mummy </option>
        <option value="wolfman"    data-class="Barabarian" data-subclass="Beast"            data-image="images/signatures/wolfman.png">Wolf Man</option>
        <option value="smith"      data-class="Monk"     data-subclass="Open Hand"          data-image="images/signatures/smith.png">Agent Smith</option>
        <option value="goblin"     data-class="Artificer" data-subclass="Armorer"           data-image="images/signatures/goblin.png">Green Goblin</option>
        <option value="jekyllhyde" data-class="Alchemist / Berserker" data-subclass="Multi" data-image="images/signatures/jekyllhyde.png">Dr Jekyl &amp; Mr. Hyde</option>
        <option value="moriarty"   data-class="Rogue"    data-subclass="MasterMind"         data-image="images/signatures/moriarty.png">Professor Moriarty</option>
        <option value="horsman"    data-class="Paladin"  data-subclass="Vengence"           data-image="images/signatures/horsman.png">The Headless Horseman</option>
        <option value="ivy"        data-class="Druid"    data-subclass="Spores"             data-image="images/signatures/ivy.png">Poison Ivy</option>
        <option value="bowser"     data-class="Sorcerer" data-subclass="Dragonic"           data-image="images/signatures/bowser.png">Bowser</option>
        <option value="strahd"     data-class="WIzard"   data-subclass="Bladesinger"        data-image="images/signatures/strahd.png">Strahd Von Zarovich</option>
      </select>

      <!-- Signature -->
      <div id="signature-container" class="signature-hidden">
        <img id="signature-img" src="images/blood_spatter.png" alt="Signature"/>
      </div>

      <!-- Mortal ID -->
      <label for="mortal-id" class="blood-text signature-hidden" id="mortal-id-label">Your Mortal ID:</label>
      <input type="text" id="mortal-id" name="mortal-id" class="signature-hidden" placeholder="Name/Discord"/>

      <button type="submit" id="acceptance-button" class="blood-text">Sign</button>
    </form>

    <img src="images/blood_spatter.png" id="blood-spatter" class="fade-hidden" alt="Blood Spatter"/>
  </div>

  <div id="custom-alert">
    <h2>Your acceptance has been sealed in blood.</h2>
    <p>See you at the Gathering...</p>
    <button id="close-alert">Close</button>
  </div>

  <div id="validation-alert" class="custom-alert signature-hidden">
    <h2 id="alert-message">Alert Message</h2>
    <button id="close-validation-alert" class="blood-text">Close</button>
  </div>

  <script>
    // Build the visible list from the hidden <select>
    (function initDropdownFromSelect(){
      const select = document.getElementById('character-name');
      const list   = document.getElementById('character-list');
      const frag   = document.createDocumentFragment();

      Array.from(select.options).forEach(opt=>{
        if(!opt.value) return; // skip placeholder
        const item = document.createElement('div');
        item.className = 'dropdown-item';
        item.setAttribute('role','option');
        item.dataset.value = opt.value;

        const name = document.createElement('span');
        name.className = 'item-name';
        name.textContent = opt.textContent;

        // (meta kept, hidden via CSS)
        const meta = document.createElement('span');
        meta.className = 'item-meta';
        meta.textContent = '';

        item.appendChild(name);
        item.appendChild(meta);
        frag.appendChild(item);
      });

      list.appendChild(frag);
    })();

    // Dropdown UI + tooltip that follows the cursor closely
    (function dropdownUI(){
    const select  = document.getElementById('character-name');
    const trigger = document.getElementById('character-trigger');
    const list    = document.getElementById('character-list');
    const tooltip = document.getElementById('class-tooltip');

    function openList(){ 
        list.classList.add('open');  
        trigger.setAttribute('aria-expanded','true'); 
    }
    function closeList(){ 
        list.classList.remove('open'); 
        trigger.setAttribute('aria-expanded','false'); 
        hideTooltip(); 
    }

    // ðŸ”¹ This was missing â€” it looks up Class/Subclass text from the <select> option
    function setTooltipTextFor(el){
        const val = el.getAttribute('data-value');
        const opt = Array.from(select.options).find(o => o.value === val);
        if(!opt) return '';
        const cls = opt.getAttribute('data-class') || '';
        const sub = opt.getAttribute('data-subclass') || '';
        return (cls || sub) ? `${cls}${cls && sub ? ' â€” ' : ''}${sub}` : '';
    }

    // Always 40px to the right and 20px above the cursor
    function positionTooltipNearCursor(e){
    const OFFSET_X = 40;
    const OFFSET_Y = 40;

    const t  = tooltip;
    const tw = t.offsetWidth;
    const th = t.offsetHeight;

    // Viewport coordinates (no scroll math needed with position: fixed)
    let x = e.clientX + OFFSET_X;
    let y = e.clientY - OFFSET_Y;   // top = 20px above cursor

    // Clamp to viewport edges
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    if (x + tw + 6 > vw) x = vw - tw - 6;
    if (x < 6)          x = 6;
    if (y + th + 6 > vh) y = vh - th - 6;
    if (y < 6)           y = 6;

    t.style.left = `${x}px`;
    t.style.top  = `${y}px`;
    }

    // Show/hide (use these or keep yours)
    function showTooltip(e, el){
    const txt = setTooltipTextFor(el);
    if(!txt){ hideTooltip(); return; }
    tooltip.textContent = txt;
    tooltip.style.opacity = 1;
    tooltip.style.transform = 'translateY(0)';
    positionTooltipNearCursor(e);
    }
    function hideTooltip(){
    tooltip.style.opacity = 0;
    tooltip.style.transform = 'translateY(-6px)';
    }

    // Toggle dropdown open/close
    trigger.addEventListener('click', ()=>{
        list.classList.contains('open') ? closeList() : openList();
    });
    document.addEventListener('click', e=>{
        if(!list.contains(e.target) && e.target !== trigger) closeList();
    });

    // Hook events for each dropdown item
    // Build/keep your showTooltip, hideTooltip, positionTooltipNearCursor as you have now

    list.querySelectorAll('.dropdown-item').forEach(el=>{
    // Use the whole row for hover, not just the name
    el.addEventListener('mouseenter', e => showTooltip(e, el));
    el.addEventListener('mousemove',  e => positionTooltipNearCursor(e)); // follow cursor smoothly
    el.addEventListener('mouseleave', hideTooltip);

    // Click still selects the row
    el.addEventListener('click', () => {
        const nameEl = el.querySelector('.item-name');
        const val  = el.getAttribute('data-value');
        const name = nameEl ? nameEl.textContent : '';
        trigger.textContent = name;
        select.value = val;
        select.dispatchEvent(new Event('change', {bubbles:true}));
        closeList();
    });
    });

    })();

    // Signature preview from data-image
    window.onload = function() {
      var signatureContainer = document.getElementById('signature-container');
      var signatureImg       = document.getElementById('signature-img');
      var mortalIdField      = document.getElementById('mortal-id');
      var mortalIdLabel      = document.getElementById('mortal-id-label');

      signatureContainer.classList.add('signature-hidden');

      document.getElementById('character-name').addEventListener('change', function() {
        var opt = this.options[this.selectedIndex];
        var imgPath = opt && opt.getAttribute('data-image');

        mortalIdField.classList.remove('signature-hidden');
        mortalIdLabel.classList.remove('signature-hidden');

        signatureContainer.classList.add('signature-hidden');
        signatureContainer.classList.remove('blood');
        signatureImg.src = '';

        if (this.value) {
          signatureContainer.classList.remove('signature-hidden');
          signatureImg.src = imgPath || 'images/blood_spatter.png';
          signatureContainer.classList.add('blood');
          mortalIdField.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
    };

    // Alerts + submit
    function showAlert(message) {
      var alertBox = document.getElementById('validation-alert');
      var alertMessage = document.getElementById('alert-message');
      alertMessage.textContent = message;
      alertBox.style.display = 'block';
    }
    document.getElementById('close-validation-alert').addEventListener('click', function() {
      document.getElementById('validation-alert').style.display = 'none';
    });
    document.getElementById('rsvp-form').addEventListener('submit', function(event) {
      event.preventDefault();
      var characterName = document.getElementById('character-name').value;
      var mortalId = document.getElementById('mortal-id').value;
      if (!characterName) return showAlert("Please select your character.");
      if (!mortalId)     return showAlert("Please enter your Mortal ID.");

      var customAlert = document.getElementById('custom-alert');
      customAlert.style.display = 'block';

      var bloodSpatter = document.getElementById('blood-spatter');
      bloodSpatter.classList.remove('fade-hidden');
      bloodSpatter.classList.add('fade-visible');

      var templateParams = { character_name: characterName, mortal_id: mortalId, message: "RSVP to Malachar's Gathering" };
      emailjs.send('service_8mr8hwu', 'template_6wow1zn', templateParams)
        .then(resp => console.log('SUCCESS!', resp.status, resp.text))
        .catch(err  => console.log('FAILED...', err));
    });
    document.getElementById('close-alert').addEventListener('click', function() {
      document.getElementById('custom-alert').style.display = 'none';
    });
  </script>

</body>
</html>
